# HomeHero v9 Refactor

This document outlines the major refactor from HomeHero8 to HomeHero9.

## Goals and Files:

- `components/hero/HomeHero9/PhysicsCanvas.tsx` – React wrapper; spawns worker, transfers canvas, relays resize and pointer events, terminates on unmount
- `components/hero/HomeHero9/physics.render.worker.ts` – main loop; imports Rapier WASM, fixed-step simulation, WebGL2 instanced drawing, posts ImageBitmap frames and periodic metrics
- `components/hero/HomeHero9/gl.ts` – WebGL helpers: context creation, shader compile/link, VAO/VBO setup, instanced draw call
- `components/hero/HomeHero9/rapier-init.ts` – bootstrap for @dimforge/rapier2d/rapier_wasm; resolves when WASM ready
- `components/hero/HomeHero9/messages.ts` – discriminated-union message contract: Init, Resize, Frame, Metrics, DragStart, DragMove, DragEnd, Impulse, Shock
- `components/hero/HomeHero9/struct.ts` – typed-array slab layout; MAX_BODIES, BYTES_PER_SLOT, makeSlabs(buf) returns Float32 arrays for pos/angle/size/vel plus Uint32 color
- `components/hero/HomeHero9/physics.config.json` – gravity, palette, bodyCount, bodyRadius, mobile overrides; parsed once inside worker
- `components/hero/HomeHero9/harness.spec.ts` – headless test; polyfills OffscreenCanvas, spawns worker, seeds RNG, steps 10 000 ticks, hashes Σxi·31^i+Σyi·17^i, fails CI on diff

## Performance Budgets:

- simulation ≤ 0.8 ms @ 256 bodies
- GPU ≤ 1 ms @ 1920×1080
- main-thread idle ≥ 95 %
- zero heap growth after 5 s.

## Changes from v8:

- `physics.worker.ts` becomes `physics.render.worker.ts`.
- `physicsConfig.ts` replaced by `physics.config.json`.
- `PhysicsSVG*.tsx` removed; one `PhysicsCanvas.tsx` handles all rendering.
- Added `gl.ts`, `rapier-init.ts`, `messages.ts`, `struct.ts`, `harness.spec.ts`.
- Planck.js swapped for Rapier WASM; Canvas2D dropped in favor of WebGL2 instancing.
- Directory path identical; file set and internals differ.
